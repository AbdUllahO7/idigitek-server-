name: Deploy idigitek-server (TSX)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 300s
        script: |
          set -e
          
          echo "ðŸ“¦ Starting deployment for idigitek-server..."
          
          cd /var/www/idigitek-server
          
          # Git configuration
          echo "ðŸ”§ Configuring git..."
          git config pull.rebase false
          git config --global --add safe.directory /var/www/idigitek-server
          
          # Pull latest changes
          echo "ðŸ“¥ Pulling latest changes..."
          git stash --include-untracked || true
          git fetch origin main
          git reset --hard origin/main
          
          # Create .env file
          echo "âš™ï¸ Creating .env file..."
          cat > .env << 'EOF'
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          NODE_ENV=development
          PORT=4000
          API_VERSION=v1
          CORS_ALLOWED_ORIGINS=https://www.idigitek.com,https://admin.idigitek.com,https://demo.idigitek.com,https://demo-dashboard.idigitek.com
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=7d
          RATE_LIMIT_WINDOW_MS=900000
          RATE_LIMIT_MAX_REQUESTS=100
          EOF
          
          # Install dependencies
          echo "ðŸ“š Installing dependencies..."
          npm ci
          
          # Restart with tsx (no build needed)
          echo "ðŸ”„ Restarting with tsx..."
          pm2 delete idigitek-server || true
          PORT=4000 pm2 start src/server.ts --name "idigitek-server" --interpreter tsx
          pm2 save
          
          echo "âœ… Deployment completed!"
          pm2 list
          pm2 logs idigitek-server --lines 20 --nostream